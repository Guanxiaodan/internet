# 互联网协议入门

从前面的文章了解到，互联网通信就是交换数据包，A给B发一个包，B收到了，给A回一个包，这样就实现了A,B通信。

### 六.用户的上网设置

#### 6.1 网关

前面讲获取mac地址时，如果两个IP地址不在同一个子网络，需要将数据包发给网关，由网关进行下一步的处理。

具体是怎么样子呢？

答：例如 子网络A下有计算机1，2；子网络B下有计算机3，4。 电脑1要给电脑4发数据包，它先判断电脑4是不是跟他同属一个子网络，结果发现不是，于是将数据包发给了子网络A的网关a,网关a通过**路由协议**，发现电脑4处于B子网络，于是就把数据包发送给B子网络的网关b，再由网关b转发给电脑4.

电脑1要发送到网关a，就需要知道网关a的MAC地址，所以实际上接收方的Mac地址，实际分为两种情况：

| 场景            | 数据包地址                  |
| -------------- |:-------------------------:|
| 同一个子网络      | 对方的MAC地址，对方的IP地址   |
| 非同一个子网络    | 网关的MAC地址，对方的IP地址   |

#### 6.2 动态IP地址

 **动态IP地址**指的是计算机开机后，会自动分配到一个IP地址，不用人为设定。这个设定的协议**DHCP协议**。
 
 DHCP协议规定，每一个子网络中，有一台计算机负责管理本网络的所有IP地址，这个计算机叫做'DHCP服务器'，新的电脑要加入网络，就必须向DHCP服务器发一个'DHCP请求'数据包，申请IP地址和相关网络参数（电脑上网必须得有这几个参数：本机IP地址，子网掩码，网关IP地址，DNS的IP地址）。
 
 但是新电脑怎么知道DHCP服务器的Mac地址和IP地址呢？
 
 答：这就是DHCP的一些巧妙规定了。首先，这协议是应用层协议，数据包长这样：
 ```angular2html
{
    head: '以太网标头',
    data: {
        head: 'IP标头',
        data: {
            head: 'UPD标头',
            data: 'DHCP数据包',
        },
    },
}
```
 其中的 以太网标头设置了发出方的Mac地址和接收方（DHCP服务器）的MAC地址，但是后者现在还不知道到，就填入FF-FF-FF-FF-FF-FF这个广播地址。
 IP标头设置了发出方的IP地址和接收方的IP地址，但是，现在这两个地址都不知道，于是，设置发出方的IP地址为0.0.0.0，接受方的IP地址为255.255.255.255。
 UPD标头设置了发出方和接收方的端口，但是DHCP协议规定发出方端口为68，接收方端口为67。
 
 构造完上面的数据包，就可以发送了，以广播的形式发送，DHCP服务器接到这个数据包后，发现IP地址是0.0.0.0和255.255.255.255，就知道这个数据包是发给我的。
 然后DHCP服务器读取数据包的内容后，分配好IP地址，发一个DHCP响应包。包含的：以太网标头的Mac地址是双方的Mac地址，IP标头是DHCP服务器的IP地址和255.255.255.255（接收方）；
 UDP标有的端口号是67（发出方）h和68（接收方），分配给请求端的IP地址和本网络的具体参数包含在data部分。
 
 于是乎，新加入的电脑就知道自己的IP地址，子网掩码，网关地址，DNS服务器等参数了。


### 七.访问网页
经过上面，设置完四项参数后，就可以上网了。

然后打开浏览器，输入www.baidu.com，这时，浏览器就向百度发送了一个网页请求的数据包。

#### 7.1 DNS服务
但是，发送数据包，必须知道对方的IP地址，但是我们只知道域名，怎么办呢？

答：DNS协议可以解决这个问题，他可以将网址转换为IP地址，因为上面我们已经知道了DNS服务器地址，所以我们向这个地址发送一个DNS数据包（53端口）
 ```angular2html
{
    head: '以太网标头',
    data: {
        head: 'IP标头',
        data: {
            head: 'UPD标头',
            data: 'DNS数据包',
        },
    },
}
```
然后DNS服务器作出响应，告诉我们对方的IP地址是多少，这样，就知道了接收方的IP地址。

#### 7.2 子网掩码

然后根据本电脑的子网掩码和IP地址，进行AND运算，算出一个结果，然后用本机的子网掩码对百度的IP地址进行AND运算（AND运算是怎么算的呢？将子网掩码和IP地址都转换为二进制--根据子网掩码，主机部分不用转换和计算--，进行两者比对，相同则为1，不同则为0，然后将计算结果转换为二进制，这样就得到了计算结果），算出一个结果，比对两个计算结果，发现不一致，所以判断出这两个IP地址不属于同一个子网络。
因此，向百度发送数据包，需要通过网关转发，也就是说，接收方的Mac地址是网关的Mac地址，并且IP地址是百度服务器的IP地址。

#### 7.3 应用层协议

浏览网页用的是HTTP协议，它的整个数据包结构是这样子：
 ```angular2html
{
    head: '以太网标头',
    data: {
        head: 'IP标头',
        data: {
            head: 'TCP标头',
            data: 'HTTP数据包',
        },
    },
}
```
HTTP数据包就是我们平常在控制台里看到的发送请求的请求头了。

#### 7.4 TCP协议
TCP数据包需要设置端口，百度的默认端口是80，发送方的端口是一个随机生成的整数。


#### 7.5 服务器相应

经过多个网关的转发，百度服务器收到了数据包，读取到里面的HTTP请求，然后做出HTTP响应，再用TCP协议发回来。

本机收到HTTP响应后，就可以将网页显示出来了，完成一次网络通信。
















